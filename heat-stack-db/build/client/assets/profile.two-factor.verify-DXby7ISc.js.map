{"version":3,"file":"profile.two-factor.verify-DXby7ISc.js","sources":["../../../app/routes/settings+/profile.two-factor.verify.tsx"],"sourcesContent":["import { getFormProps, getInputProps, useForm } from '@conform-to/react'\nimport { getZodConstraint, parseWithZod } from '@conform-to/zod'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tjson,\n\tredirect,\n\ttype LoaderFunctionArgs,\n\ttype ActionFunctionArgs,\n} from '@remix-run/node'\nimport {\n\tForm,\n\tuseActionData,\n\tuseLoaderData,\n\tuseNavigation,\n} from '@remix-run/react'\nimport * as QRCode from 'qrcode'\nimport { z } from 'zod'\nimport { ErrorList, OTPField } from '#app/components/forms.tsx'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport { isCodeValid } from '#app/routes/_auth+/verify.server.ts'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { prisma } from '#app/utils/db.server.ts'\nimport { getDomainUrl, useIsPending } from '#app/utils/misc.tsx'\nimport { redirectWithToast } from '#app/utils/toast.server.ts'\nimport { getTOTPAuthUri } from '#app/utils/totp.server.ts'\nimport { type BreadcrumbHandle } from './profile.tsx'\nimport { twoFAVerificationType } from './profile.two-factor.tsx'\n\nexport const handle: BreadcrumbHandle & SEOHandle = {\n\tbreadcrumb: <Icon name=\"check\">Verify</Icon>,\n\tgetSitemapEntries: () => null,\n}\n\nconst CancelSchema = z.object({ intent: z.literal('cancel') })\nconst VerifySchema = z.object({\n\tintent: z.literal('verify'),\n\tcode: z.string().min(6).max(6),\n})\n\nconst ActionSchema = z.discriminatedUnion('intent', [\n\tCancelSchema,\n\tVerifySchema,\n])\n\nexport const twoFAVerifyVerificationType = '2fa-verify'\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst verification = await prisma.verification.findUnique({\n\t\twhere: {\n\t\t\ttarget_type: { type: twoFAVerifyVerificationType, target: userId },\n\t\t},\n\t\tselect: {\n\t\t\tid: true,\n\t\t\talgorithm: true,\n\t\t\tsecret: true,\n\t\t\tperiod: true,\n\t\t\tdigits: true,\n\t\t},\n\t})\n\tif (!verification) {\n\t\treturn redirect('/settings/profile/two-factor')\n\t}\n\tconst user = await prisma.user.findUniqueOrThrow({\n\t\twhere: { id: userId },\n\t\tselect: { email: true },\n\t})\n\tconst issuer = new URL(getDomainUrl(request)).host\n\tconst otpUri = getTOTPAuthUri({\n\t\t...verification,\n\t\taccountName: user.email,\n\t\tissuer,\n\t})\n\tconst qrCode = await QRCode.toDataURL(otpUri)\n\treturn json({ otpUri, qrCode })\n}\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst formData = await request.formData()\n\n\tconst submission = await parseWithZod(formData, {\n\t\tschema: () =>\n\t\t\tActionSchema.superRefine(async (data, ctx) => {\n\t\t\t\tif (data.intent === 'cancel') return null\n\t\t\t\tconst codeIsValid = await isCodeValid({\n\t\t\t\t\tcode: data.code,\n\t\t\t\t\ttype: twoFAVerifyVerificationType,\n\t\t\t\t\ttarget: userId,\n\t\t\t\t})\n\t\t\t\tif (!codeIsValid) {\n\t\t\t\t\tctx.addIssue({\n\t\t\t\t\t\tpath: ['code'],\n\t\t\t\t\t\tcode: z.ZodIssueCode.custom,\n\t\t\t\t\t\tmessage: `Invalid code`,\n\t\t\t\t\t})\n\t\t\t\t\treturn z.NEVER\n\t\t\t\t}\n\t\t\t}),\n\t\tasync: true,\n\t})\n\n\tif (submission.status !== 'success') {\n\t\treturn json(\n\t\t\t{ result: submission.reply() },\n\t\t\t{ status: submission.status === 'error' ? 400 : 200 },\n\t\t)\n\t}\n\n\tswitch (submission.value.intent) {\n\t\tcase 'cancel': {\n\t\t\tawait prisma.verification.deleteMany({\n\t\t\t\twhere: { type: twoFAVerifyVerificationType, target: userId },\n\t\t\t})\n\t\t\treturn redirect('/settings/profile/two-factor')\n\t\t}\n\t\tcase 'verify': {\n\t\t\tawait prisma.verification.update({\n\t\t\t\twhere: {\n\t\t\t\t\ttarget_type: { type: twoFAVerifyVerificationType, target: userId },\n\t\t\t\t},\n\t\t\t\tdata: { type: twoFAVerificationType },\n\t\t\t})\n\t\t\treturn redirectWithToast('/settings/profile/two-factor', {\n\t\t\t\ttype: 'success',\n\t\t\t\ttitle: 'Enabled',\n\t\t\t\tdescription: 'Two-factor authentication has been enabled.',\n\t\t\t})\n\t\t}\n\t}\n}\n\nexport default function TwoFactorRoute() {\n\tconst data = useLoaderData<typeof loader>()\n\tconst actionData = useActionData<typeof action>()\n\tconst navigation = useNavigation()\n\n\tconst isPending = useIsPending()\n\tconst pendingIntent = isPending ? navigation.formData?.get('intent') : null\n\n\tconst [form, fields] = useForm({\n\t\tid: 'verify-form',\n\t\tconstraint: getZodConstraint(ActionSchema),\n\t\tlastResult: actionData?.result,\n\t\tonValidate({ formData }) {\n\t\t\treturn parseWithZod(formData, { schema: ActionSchema })\n\t\t},\n\t})\n\tconst lastSubmissionIntent = fields.intent.value\n\n\treturn (\n\t\t<div>\n\t\t\t<div className=\"flex flex-col items-center gap-4\">\n\t\t\t\t<img alt=\"qr code\" src={data.qrCode} className=\"h-56 w-56\" />\n\t\t\t\t<p>Scan this QR code with your authenticator app.</p>\n\t\t\t\t<p className=\"text-sm\">\n\t\t\t\t\tIf you cannot scan the QR code, you can manually add this account to\n\t\t\t\t\tyour authenticator app using this code:\n\t\t\t\t</p>\n\t\t\t\t<div className=\"p-3\">\n\t\t\t\t\t<pre\n\t\t\t\t\t\tclassName=\"whitespace-pre-wrap break-all text-sm\"\n\t\t\t\t\t\taria-label=\"One-time Password URI\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{data.otpUri}\n\t\t\t\t\t</pre>\n\t\t\t\t</div>\n\t\t\t\t<p className=\"text-sm\">\n\t\t\t\t\tOnce you've added the account, enter the code from your authenticator\n\t\t\t\t\tapp below. Once you enable 2FA, you will need to enter a code from\n\t\t\t\t\tyour authenticator app every time you log in or perform important\n\t\t\t\t\tactions. Do not lose access to your authenticator app, or you will\n\t\t\t\t\tlose access to your account.\n\t\t\t\t</p>\n\t\t\t\t<div className=\"flex w-full max-w-xs flex-col justify-center gap-4\">\n\t\t\t\t\t<Form method=\"POST\" {...getFormProps(form)} className=\"flex-1\">\n\t\t\t\t\t\t<div className=\"flex items-center justify-center\">\n\t\t\t\t\t\t\t<OTPField\n\t\t\t\t\t\t\t\tlabelProps={{\n\t\t\t\t\t\t\t\t\thtmlFor: fields.code.id,\n\t\t\t\t\t\t\t\t\tchildren: 'Code',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\t\t\t...getInputProps(fields.code, { type: 'text' }),\n\t\t\t\t\t\t\t\t\tautoFocus: true,\n\t\t\t\t\t\t\t\t\tautoComplete: 'one-time-code',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\terrors={fields.code.errors}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div className=\"min-h-[32px] px-4 pb-3 pt-1\">\n\t\t\t\t\t\t\t<ErrorList id={form.errorId} errors={form.errors} />\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div className=\"flex justify-between gap-4\">\n\t\t\t\t\t\t\t<StatusButton\n\t\t\t\t\t\t\t\tclassName=\"w-full\"\n\t\t\t\t\t\t\t\tstatus={\n\t\t\t\t\t\t\t\t\tpendingIntent === 'verify'\n\t\t\t\t\t\t\t\t\t\t? 'pending'\n\t\t\t\t\t\t\t\t\t\t: lastSubmissionIntent === 'verify'\n\t\t\t\t\t\t\t\t\t\t\t? form.status ?? 'idle'\n\t\t\t\t\t\t\t\t\t\t\t: 'idle'\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\t\tname=\"intent\"\n\t\t\t\t\t\t\t\tvalue=\"verify\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSubmit\n\t\t\t\t\t\t\t</StatusButton>\n\t\t\t\t\t\t\t<StatusButton\n\t\t\t\t\t\t\t\tclassName=\"w-full\"\n\t\t\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\t\t\tstatus={\n\t\t\t\t\t\t\t\t\tpendingIntent === 'cancel'\n\t\t\t\t\t\t\t\t\t\t? 'pending'\n\t\t\t\t\t\t\t\t\t\t: lastSubmissionIntent === 'cancel'\n\t\t\t\t\t\t\t\t\t\t\t? form.status ?? 'idle'\n\t\t\t\t\t\t\t\t\t\t\t: 'idle'\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\t\tname=\"intent\"\n\t\t\t\t\t\t\t\tvalue=\"cancel\"\n\t\t\t\t\t\t\t\tdisabled={isPending}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</StatusButton>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n"],"names":["handle","breadcrumb","jsx","Icon","name","children","getSitemapEntries","CancelSchema","z","object","intent","literal","VerifySchema","code","string","min","max","ActionSchema","discriminatedUnion","TwoFactorRoute","data","useLoaderData","actionData","useActionData","navigation","useNavigation","isPending","useIsPending","pendingIntent","formData","get","form","fields","useForm","id","constraint","getZodConstraint","lastResult","result","onValidate","parseWithZod","schema","lastSubmissionIntent","value","jsxs","className","alt","src","qrCode","otpUri","Form","method","getFormProps","OTPField","labelProps","htmlFor","inputProps","getInputProps","type","autoFocus","autoComplete","errors","ErrorList","errorId","StatusButton","status","variant","disabled"],"mappings":"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"}