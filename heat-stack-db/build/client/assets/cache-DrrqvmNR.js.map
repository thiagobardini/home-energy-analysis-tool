{"version":3,"file":"cache-DrrqvmNR.js","sources":["../../../app/routes/admin+/cache.tsx"],"sourcesContent":["import { invariantResponse } from '@epic-web/invariant'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tjson,\n\tredirect,\n\ttype LoaderFunctionArgs,\n\ttype ActionFunctionArgs,\n} from '@remix-run/node'\nimport {\n\tForm,\n\tLink,\n\tuseFetcher,\n\tuseLoaderData,\n\tuseSearchParams,\n\tuseSubmit,\n} from '@remix-run/react'\nimport { GeneralErrorBoundary } from '#app/components/error-boundary'\nimport { Field } from '#app/components/forms.tsx'\nimport { Spacer } from '#app/components/spacer.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport {\n\tcache,\n\tgetAllCacheKeys,\n\tlruCache,\n\tsearchCacheKeys,\n} from '#app/utils/cache.server.ts'\nimport {\n\tensureInstance,\n\tgetAllInstances,\n\tgetInstanceInfo,\n} from '#app/utils/litefs.server.ts'\nimport { useDebounce, useDoubleCheck } from '#app/utils/misc.tsx'\nimport { requireUserWithRole } from '#app/utils/permissions.server.ts'\n\nexport const handle: SEOHandle = {\n\tgetSitemapEntries: () => null,\n}\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst searchParams = new URL(request.url).searchParams\n\tconst query = searchParams.get('query')\n\tif (query === '') {\n\t\tsearchParams.delete('query')\n\t\treturn redirect(`/admin/cache?${searchParams.toString()}`)\n\t}\n\tconst limit = Number(searchParams.get('limit') ?? 100)\n\n\tconst currentInstanceInfo = await getInstanceInfo()\n\tconst instance =\n\t\tsearchParams.get('instance') ?? currentInstanceInfo.currentInstance\n\tconst instances = await getAllInstances()\n\tawait ensureInstance(instance)\n\n\tlet cacheKeys: { sqlite: Array<string>; lru: Array<string> }\n\tif (typeof query === 'string') {\n\t\tcacheKeys = await searchCacheKeys(query, limit)\n\t} else {\n\t\tcacheKeys = await getAllCacheKeys(limit)\n\t}\n\treturn json({ cacheKeys, instance, instances, currentInstanceInfo })\n}\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst formData = await request.formData()\n\tconst key = formData.get('cacheKey')\n\tconst { currentInstance } = await getInstanceInfo()\n\tconst instance = formData.get('instance') ?? currentInstance\n\tconst type = formData.get('type')\n\n\tinvariantResponse(typeof key === 'string', 'cacheKey must be a string')\n\tinvariantResponse(typeof type === 'string', 'type must be a string')\n\tinvariantResponse(typeof instance === 'string', 'instance must be a string')\n\tawait ensureInstance(instance)\n\n\tswitch (type) {\n\t\tcase 'sqlite': {\n\t\t\tawait cache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tcase 'lru': {\n\t\t\tlruCache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tdefault: {\n\t\t\tthrow new Error(`Unknown cache type: ${type}`)\n\t\t}\n\t}\n\treturn json({ success: true })\n}\n\nexport default function CacheAdminRoute() {\n\tconst data = useLoaderData<typeof loader>()\n\tconst [searchParams] = useSearchParams()\n\tconst submit = useSubmit()\n\tconst query = searchParams.get('query') ?? ''\n\tconst limit = searchParams.get('limit') ?? '100'\n\tconst instance = searchParams.get('instance') ?? data.instance\n\n\tconst handleFormChange = useDebounce((form: HTMLFormElement) => {\n\t\tsubmit(form)\n\t}, 400)\n\n\treturn (\n\t\t<div className=\"container\">\n\t\t\t<h1 className=\"text-h1\">Cache Admin</h1>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<Form\n\t\t\t\tmethod=\"get\"\n\t\t\t\tclassName=\"flex flex-col gap-4\"\n\t\t\t\tonChange={e => handleFormChange(e.currentTarget)}\n\t\t\t>\n\t\t\t\t<div className=\"flex-1\">\n\t\t\t\t\t<div className=\"flex flex-1 gap-4\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\tclassName=\"flex h-16 items-center justify-center\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tðŸ”Ž\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<Field\n\t\t\t\t\t\t\tclassName=\"flex-1\"\n\t\t\t\t\t\t\tlabelProps={{ children: 'Search' }}\n\t\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\t\ttype: 'search',\n\t\t\t\t\t\t\t\tname: 'query',\n\t\t\t\t\t\t\t\tdefaultValue: query,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div className=\"flex h-16 w-14 items-center text-lg font-medium text-muted-foreground\">\n\t\t\t\t\t\t\t<span title=\"Total results shown\">\n\t\t\t\t\t\t\t\t{data.cacheKeys.sqlite.length + data.cacheKeys.lru.length}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"flex flex-wrap items-center gap-4\">\n\t\t\t\t\t<Field\n\t\t\t\t\t\tlabelProps={{\n\t\t\t\t\t\t\tchildren: 'Limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\tname: 'limit',\n\t\t\t\t\t\t\tdefaultValue: limit,\n\t\t\t\t\t\t\ttype: 'number',\n\t\t\t\t\t\t\tstep: '1',\n\t\t\t\t\t\t\tmin: '1',\n\t\t\t\t\t\t\tmax: '10000',\n\t\t\t\t\t\t\tplaceholder: 'results limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t\t<select name=\"instance\" defaultValue={instance}>\n\t\t\t\t\t\t{Object.entries(data.instances).map(([inst, region]) => (\n\t\t\t\t\t\t\t<option key={inst} value={inst}>\n\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\tinst,\n\t\t\t\t\t\t\t\t\t`(${region})`,\n\t\t\t\t\t\t\t\t\tinst === data.currentInstanceInfo.currentInstance\n\t\t\t\t\t\t\t\t\t\t? '(current)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t\tinst === data.currentInstanceInfo.primaryInstance\n\t\t\t\t\t\t\t\t\t\t? ' (primary)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t.filter(Boolean)\n\t\t\t\t\t\t\t\t\t.join(' ')}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</Form>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">LRU Cache:</h2>\n\t\t\t\t{data.cacheKeys.lru.map(key => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"lru\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t\t<Spacer size=\"3xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">SQLite Cache:</h2>\n\t\t\t\t{data.cacheKeys.sqlite.map(key => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"sqlite\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nfunction CacheKeyRow({\n\tcacheKey,\n\tinstance,\n\ttype,\n}: {\n\tcacheKey: string\n\tinstance?: string\n\ttype: 'sqlite' | 'lru'\n}) {\n\tconst fetcher = useFetcher<typeof action>()\n\tconst dc = useDoubleCheck()\n\tconst encodedKey = encodeURIComponent(cacheKey)\n\tconst valuePage = `/admin/cache/${type}/${encodedKey}?instance=${instance}`\n\treturn (\n\t\t<div className=\"flex items-center gap-2 font-mono\">\n\t\t\t<fetcher.Form method=\"POST\">\n\t\t\t\t<input type=\"hidden\" name=\"cacheKey\" value={cacheKey} />\n\t\t\t\t<input type=\"hidden\" name=\"instance\" value={instance} />\n\t\t\t\t<input type=\"hidden\" name=\"type\" value={type} />\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t{...dc.getButtonProps({ type: 'submit' })}\n\t\t\t\t>\n\t\t\t\t\t{fetcher.state === 'idle'\n\t\t\t\t\t\t? dc.doubleCheck\n\t\t\t\t\t\t\t? 'You sure?'\n\t\t\t\t\t\t\t: 'Delete'\n\t\t\t\t\t\t: 'Deleting...'}\n\t\t\t\t</Button>\n\t\t\t</fetcher.Form>\n\t\t\t<Link reloadDocument to={valuePage}>\n\t\t\t\t{cacheKey}\n\t\t\t</Link>\n\t\t</div>\n\t)\n}\n\nexport function ErrorBoundary() {\n\treturn (\n\t\t<GeneralErrorBoundary\n\t\t\tstatusHandlers={{\n\t\t\t\t403: ({ error }) => (\n\t\t\t\t\t<p>You are not allowed to do that: {error?.data.message}</p>\n\t\t\t\t),\n\t\t\t}}\n\t\t/>\n\t)\n}\n"],"names":["handle","getSitemapEntries","CacheAdminRoute","data","useLoaderData","searchParams","useSearchParams","submit","useSubmit","query","get","limit","instance","handleFormChange","useDebounce","form","jsxs","className","children","jsx","Spacer","size","Form","method","onChange","e","currentTarget","type","Field","labelProps","inputProps","name","defaultValue","title","cacheKeys","sqlite","length","lru","step","min","max","placeholder","Object","entries","instances","map","inst","region","value","currentInstanceInfo","currentInstance","primaryInstance","filter","Boolean","join","key","CacheKeyRow","cacheKey","fetcher","useFetcher","dc","useDoubleCheck","encodedKey","encodeURIComponent","valuePage","Button","variant","getButtonProps","state","doubleCheck","Link","reloadDocument","to","ErrorBoundary","GeneralErrorBoundary","statusHandlers","error","message"],"mappings":"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"}