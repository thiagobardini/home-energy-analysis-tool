{"version":3,"file":"profile.connections-nQM8T2xY.js","sources":["../../../app/routes/settings+/profile.connections.tsx"],"sourcesContent":["import { invariantResponse } from '@epic-web/invariant'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tjson,\n\ttype LoaderFunctionArgs,\n\ttype ActionFunctionArgs,\n\ttype SerializeFrom,\n\ttype HeadersFunction,\n} from '@remix-run/node'\nimport { useFetcher, useLoaderData } from '@remix-run/react'\nimport { useState } from 'react'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport {\n\tTooltip,\n\tTooltipContent,\n\tTooltipProvider,\n\tTooltipTrigger,\n} from '#app/components/ui/tooltip.tsx'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { resolveConnectionData } from '#app/utils/connections.server.ts'\nimport {\n\tProviderConnectionForm,\n\ttype ProviderName,\n\tProviderNameSchema,\n\tproviderIcons,\n\tproviderNames,\n} from '#app/utils/connections.tsx'\nimport { prisma } from '#app/utils/db.server.ts'\nimport { makeTimings } from '#app/utils/timing.server.ts'\nimport { createToastHeaders } from '#app/utils/toast.server.ts'\nimport { type BreadcrumbHandle } from './profile.tsx'\n\nexport const handle: BreadcrumbHandle & SEOHandle = {\n\tbreadcrumb: <Icon name=\"link-2\">Connections</Icon>,\n\tgetSitemapEntries: () => null,\n}\n\nasync function userCanDeleteConnections(userId: string) {\n\tconst user = await prisma.user.findUnique({\n\t\tselect: {\n\t\t\tpassword: { select: { userId: true } },\n\t\t\t_count: { select: { connections: true } },\n\t\t},\n\t\twhere: { id: userId },\n\t})\n\t// user can delete their connections if they have a password\n\tif (user?.password) return true\n\t// users have to have more than one remaining connection to delete one\n\treturn Boolean(user?._count.connections && user?._count.connections > 1)\n}\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst timings = makeTimings('profile connections loader')\n\tconst rawConnections = await prisma.connection.findMany({\n\t\tselect: { id: true, providerName: true, providerId: true, createdAt: true },\n\t\twhere: { userId },\n\t})\n\tconst connections: Array<{\n\t\tproviderName: ProviderName\n\t\tid: string\n\t\tdisplayName: string\n\t\tlink?: string | null\n\t\tcreatedAtFormatted: string\n\t}> = []\n\tfor (const connection of rawConnections) {\n\t\tconst r = ProviderNameSchema.safeParse(connection.providerName)\n\t\tif (!r.success) continue\n\t\tconst providerName = r.data\n\t\tconst connectionData = await resolveConnectionData(\n\t\t\tproviderName,\n\t\t\tconnection.providerId,\n\t\t\t{ timings },\n\t\t)\n\t\tconnections.push({\n\t\t\t...connectionData,\n\t\t\tproviderName,\n\t\t\tid: connection.id,\n\t\t\tcreatedAtFormatted: connection.createdAt.toLocaleString(),\n\t\t})\n\t}\n\n\treturn json(\n\t\t{\n\t\t\tconnections,\n\t\t\tcanDeleteConnections: await userCanDeleteConnections(userId),\n\t\t},\n\t\t{ headers: { 'Server-Timing': timings.toString() } },\n\t)\n}\n\nexport const headers: HeadersFunction = ({ loaderHeaders }) => {\n\tconst headers = {\n\t\t'Server-Timing': loaderHeaders.get('Server-Timing') ?? '',\n\t}\n\treturn headers\n}\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst formData = await request.formData()\n\tinvariantResponse(\n\t\tformData.get('intent') === 'delete-connection',\n\t\t'Invalid intent',\n\t)\n\tinvariantResponse(\n\t\tawait userCanDeleteConnections(userId),\n\t\t'You cannot delete your last connection unless you have a password.',\n\t)\n\tconst connectionId = formData.get('connectionId')\n\tinvariantResponse(typeof connectionId === 'string', 'Invalid connectionId')\n\tawait prisma.connection.delete({\n\t\twhere: {\n\t\t\tid: connectionId,\n\t\t\tuserId: userId,\n\t\t},\n\t})\n\tconst toastHeaders = await createToastHeaders({\n\t\ttitle: 'Deleted',\n\t\tdescription: 'Your connection has been deleted.',\n\t})\n\treturn json({ status: 'success' } as const, { headers: toastHeaders })\n}\n\nexport default function Connections() {\n\tconst data = useLoaderData<typeof loader>()\n\n\treturn (\n\t\t<div className=\"mx-auto max-w-md\">\n\t\t\t{data.connections.length ? (\n\t\t\t\t<div className=\"flex flex-col gap-2\">\n\t\t\t\t\t<p>Here are your current connections:</p>\n\t\t\t\t\t<ul className=\"flex flex-col gap-4\">\n\t\t\t\t\t\t{data.connections.map(c => (\n\t\t\t\t\t\t\t<li key={c.id}>\n\t\t\t\t\t\t\t\t<Connection\n\t\t\t\t\t\t\t\t\tconnection={c}\n\t\t\t\t\t\t\t\t\tcanDelete={data.canDeleteConnections}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t) : (\n\t\t\t\t<p>You don't have any connections yet.</p>\n\t\t\t)}\n\t\t\t<div className=\"mt-5 flex flex-col gap-5 border-b-2 border-t-2 border-border py-3\">\n\t\t\t\t{providerNames.map(providerName => (\n\t\t\t\t\t<ProviderConnectionForm\n\t\t\t\t\t\tkey={providerName}\n\t\t\t\t\t\ttype=\"Connect\"\n\t\t\t\t\t\tproviderName={providerName}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nfunction Connection({\n\tconnection,\n\tcanDelete,\n}: {\n\tconnection: SerializeFrom<typeof loader>['connections'][number]\n\tcanDelete: boolean\n}) {\n\tconst deleteFetcher = useFetcher<typeof action>()\n\tconst [infoOpen, setInfoOpen] = useState(false)\n\tconst icon = providerIcons[connection.providerName]\n\treturn (\n\t\t<div className=\"flex justify-between gap-2\">\n\t\t\t<span className={`inline-flex items-center gap-1.5`}>\n\t\t\t\t{icon}\n\t\t\t\t<span>\n\t\t\t\t\t{connection.link ? (\n\t\t\t\t\t\t<a href={connection.link} className=\"underline\">\n\t\t\t\t\t\t\t{connection.displayName}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t) : (\n\t\t\t\t\t\tconnection.displayName\n\t\t\t\t\t)}{' '}\n\t\t\t\t\t({connection.createdAtFormatted})\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t\t{canDelete ? (\n\t\t\t\t<deleteFetcher.Form method=\"POST\">\n\t\t\t\t\t<input name=\"connectionId\" value={connection.id} type=\"hidden\" />\n\t\t\t\t\t<TooltipProvider>\n\t\t\t\t\t\t<Tooltip>\n\t\t\t\t\t\t\t<TooltipTrigger asChild>\n\t\t\t\t\t\t\t\t<StatusButton\n\t\t\t\t\t\t\t\t\tname=\"intent\"\n\t\t\t\t\t\t\t\t\tvalue=\"delete-connection\"\n\t\t\t\t\t\t\t\t\tvariant=\"destructive\"\n\t\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\t\tstatus={\n\t\t\t\t\t\t\t\t\t\tdeleteFetcher.state !== 'idle'\n\t\t\t\t\t\t\t\t\t\t\t? 'pending'\n\t\t\t\t\t\t\t\t\t\t\t: deleteFetcher.data?.status ?? 'idle'\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<Icon name=\"cross-1\" />\n\t\t\t\t\t\t\t\t</StatusButton>\n\t\t\t\t\t\t\t</TooltipTrigger>\n\t\t\t\t\t\t\t<TooltipContent>Disconnect this account</TooltipContent>\n\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t</TooltipProvider>\n\t\t\t\t</deleteFetcher.Form>\n\t\t\t) : (\n\t\t\t\t<TooltipProvider>\n\t\t\t\t\t<Tooltip open={infoOpen} onOpenChange={setInfoOpen}>\n\t\t\t\t\t\t<TooltipTrigger onClick={() => setInfoOpen(true)}>\n\t\t\t\t\t\t\t<Icon name=\"question-mark-circled\"></Icon>\n\t\t\t\t\t\t</TooltipTrigger>\n\t\t\t\t\t\t<TooltipContent>\n\t\t\t\t\t\t\tYou cannot delete your last connection unless you have a password.\n\t\t\t\t\t\t</TooltipContent>\n\t\t\t\t\t</Tooltip>\n\t\t\t\t</TooltipProvider>\n\t\t\t)}\n\t\t</div>\n\t)\n}\n"],"names":["handle","breadcrumb","jsx","Icon","name","children","getSitemapEntries","Connections","data","useLoaderData","jsxs","className","connections","length","map","c","Connection","connection","canDelete","canDeleteConnections","id","providerNames","providerName","ProviderConnectionForm","type","deleteFetcher","useFetcher","infoOpen","setInfoOpen","useState","icon","providerIcons","link","href","displayName","createdAtFormatted","Form","method","value","TooltipProvider","Tooltip","TooltipTrigger","asChild","StatusButton","variant","size","status","state","TooltipContent","open","onOpenChange","onClick"],"mappings":"meAiCO,MAAMA,EAAuC,CACnDC,WAAYC,EAAA,IAACC,EAAK,CAAAC,KAAK,SAASC,SAAW,aAAA,CAAA,EAC3CC,kBAAmBA,IAAM,IAC1B,EAyFA,SAAwBC,GAAc,CACrC,MAAMC,EAAOC,IAGZ,OAAAC,EAAAA,KAAC,MAAI,CAAAC,UAAU,mBACbN,SAAA,CAAAG,EAAKI,YAAYC,OAChBH,EAAAA,KAAA,MAAA,CAAIC,UAAU,sBACdN,SAAA,CAAAH,EAAA,IAAC,KAAEG,SAAkC,oCAAA,CAAA,EACrCH,EAAA,IAAC,MAAGS,UAAU,sBACZN,WAAKO,YAAYE,IACjBC,GAAAb,EAAA,IAAC,KACA,CAAAG,SAAAH,EAAA,IAACc,EAAA,CACAC,WAAYF,EACZG,UAAWV,EAAKW,qBACjB,CAJQ,EAAAJ,EAAEK,EAKX,CACA,CACF,CAAA,CAAA,CACD,CAAA,EAEClB,EAAA,IAAA,IAAA,CAAEG,SAAmC,qCAAA,CAAA,QAEtC,MAAI,CAAAM,UAAU,oEACbN,SAAAgB,EAAcP,IACdQ,GAAApB,EAAAA,IAACqB,EAAA,CAEAC,KAAK,UACLF,aAAAA,CAAA,EAFKA,CAGN,CACA,CACF,CAAA,CAAA,CACD,CAAA,CAEF,CAEA,SAASN,EAAW,CACnBC,WAAAA,EACAC,UAAAA,CACD,EAGG,OACF,MAAMO,EAAgBC,IAChB,CAACC,EAAUC,CAAW,EAAIC,WAAS,EAAK,EACxCC,EAAOC,EAAcd,EAAWK,YAAY,EAEjD,OAAAZ,EAAAA,KAAC,MAAI,CAAAC,UAAU,6BACdN,SAAA,CAACK,EAAA,KAAA,OAAA,CAAKC,UAAW,mCACfN,SAAA,CAAAyB,SACA,OACC,CAAAzB,SAAA,CAAWY,EAAAe,KACV9B,EAAAA,IAAA,IAAA,CAAE+B,KAAMhB,EAAWe,KAAMrB,UAAU,YAClCN,SAAAY,EAAWiB,WACb,CAAA,EAEAjB,EAAWiB,YACT,IAAI,IACLjB,EAAWkB,mBAAmB,GAAA,CACjC,CAAA,CAAA,CACD,CAAA,EACCjB,EACCR,OAAAe,EAAcW,KAAd,CAAmBC,OAAO,OAC1BhC,SAAA,CAAAH,EAAA,IAAC,SAAME,KAAK,eAAekC,MAAOrB,EAAWG,GAAII,KAAK,QAAS,CAAA,EAC/DtB,EAAA,IAACqC,EACA,CAAAlC,SAAAK,EAAA,KAAC8B,EACA,CAAAnC,SAAA,CAACH,EAAA,IAAAuC,EAAA,CAAeC,QAAO,GACtBrC,SAAAH,EAAA,IAACyC,EAAA,CACAvC,KAAK,SACLkC,MAAM,oBACNM,QAAQ,cACRC,KAAK,KACLC,OACCrB,EAAcsB,QAAU,OACrB,YACAtB,EAAAA,EAAcjB,OAAdiB,YAAAA,EAAoBqB,SAAU,OAGlCzC,SAAAH,EAAA,IAACC,EAAK,CAAAC,KAAK,UAAU,EACtB,CACD,CAAA,EACAF,EAAA,IAAC8C,GAAe3C,SAAuB,yBAAA,CAAA,CAAA,EACxC,CACD,CAAA,CAAA,CACD,CAAA,QAECkC,EACA,CAAAlC,SAAAK,EAAA,KAAC8B,GAAQS,KAAMtB,EAAUuB,aAActB,EACtCvB,SAAA,CAACH,EAAA,IAAAuC,EAAA,CAAeU,QAASA,IAAMvB,EAAY,EAAI,EAC9CvB,SAACH,EAAA,IAAAC,EAAA,CAAKC,KAAK,wBAAwB,CACpC,CAAA,EACAF,EAAA,IAAC8C,GAAe3C,SAEhB,oEAAA,CAAA,CAAA,EACD,CACD,CAAA,CAAA,CAEF,CAAA,CAEF"}