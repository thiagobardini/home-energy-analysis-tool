{"version":3,"file":"profile.change-email-D5A4idJw.js","sources":["../../../app/routes/settings+/profile.change-email.tsx"],"sourcesContent":["import { getFormProps, getInputProps, useForm } from '@conform-to/react'\nimport { getZodConstraint, parseWithZod } from '@conform-to/zod'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tjson,\n\tredirect,\n\ttype ActionFunctionArgs,\n\ttype LoaderFunctionArgs,\n} from '@remix-run/node'\nimport { Form, useActionData, useLoaderData } from '@remix-run/react'\nimport { z } from 'zod'\nimport { ErrorList, Field } from '#app/components/forms.tsx'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport {\n\tprepareVerification,\n\trequireRecentVerification,\n} from '#app/routes/_auth+/verify.server.ts'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { prisma } from '#app/utils/db.server.ts'\nimport { sendEmail } from '#app/utils/email.server.ts'\nimport { useIsPending } from '#app/utils/misc.tsx'\nimport { EmailSchema } from '#app/utils/user-validation.ts'\nimport { verifySessionStorage } from '#app/utils/verification.server.ts'\nimport { EmailChangeEmail } from './profile.change-email.server.tsx'\nimport { type BreadcrumbHandle } from './profile.tsx'\n\nexport const handle: BreadcrumbHandle & SEOHandle = {\n\tbreadcrumb: <Icon name=\"envelope-closed\">Change Email</Icon>,\n\tgetSitemapEntries: () => null,\n}\n\nexport const newEmailAddressSessionKey = 'new-email-address'\n\nconst ChangeEmailSchema = z.object({\n\temail: EmailSchema,\n})\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n\tawait requireRecentVerification(request)\n\tconst userId = await requireUserId(request)\n\tconst user = await prisma.user.findUnique({\n\t\twhere: { id: userId },\n\t\tselect: { email: true },\n\t})\n\tif (!user) {\n\t\tconst params = new URLSearchParams({ redirectTo: request.url })\n\t\tthrow redirect(`/login?${params}`)\n\t}\n\treturn json({ user })\n}\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst formData = await request.formData()\n\tconst submission = await parseWithZod(formData, {\n\t\tschema: ChangeEmailSchema.superRefine(async (data, ctx) => {\n\t\t\tconst existingUser = await prisma.user.findUnique({\n\t\t\t\twhere: { email: data.email },\n\t\t\t})\n\t\t\tif (existingUser) {\n\t\t\t\tctx.addIssue({\n\t\t\t\t\tpath: ['email'],\n\t\t\t\t\tcode: z.ZodIssueCode.custom,\n\t\t\t\t\tmessage: 'This email is already in use.',\n\t\t\t\t})\n\t\t\t}\n\t\t}),\n\t\tasync: true,\n\t})\n\n\tif (submission.status !== 'success') {\n\t\treturn json(\n\t\t\t{ result: submission.reply() },\n\t\t\t{ status: submission.status === 'error' ? 400 : 200 },\n\t\t)\n\t}\n\tconst { otp, redirectTo, verifyUrl } = await prepareVerification({\n\t\tperiod: 10 * 60,\n\t\trequest,\n\t\ttarget: userId,\n\t\ttype: 'change-email',\n\t})\n\n\tconst response = await sendEmail({\n\t\tto: submission.value.email,\n\t\tsubject: `Epic Notes Email Change Verification`,\n\t\treact: <EmailChangeEmail verifyUrl={verifyUrl.toString()} otp={otp} />,\n\t})\n\n\tif (response.status === 'success') {\n\t\tconst verifySession = await verifySessionStorage.getSession()\n\t\tverifySession.set(newEmailAddressSessionKey, submission.value.email)\n\t\treturn redirect(redirectTo.toString(), {\n\t\t\theaders: {\n\t\t\t\t'set-cookie': await verifySessionStorage.commitSession(verifySession),\n\t\t\t},\n\t\t})\n\t} else {\n\t\treturn json(\n\t\t\t{ result: submission.reply({ formErrors: [response.error.message] }) },\n\t\t\t{ status: 500 },\n\t\t)\n\t}\n}\n\nexport default function ChangeEmailIndex() {\n\tconst data = useLoaderData<typeof loader>()\n\tconst actionData = useActionData<typeof action>()\n\n\tconst [form, fields] = useForm({\n\t\tid: 'change-email-form',\n\t\tconstraint: getZodConstraint(ChangeEmailSchema),\n\t\tlastResult: actionData?.result,\n\t\tonValidate({ formData }) {\n\t\t\treturn parseWithZod(formData, { schema: ChangeEmailSchema })\n\t\t},\n\t})\n\n\tconst isPending = useIsPending()\n\treturn (\n\t\t<div>\n\t\t\t<h1 className=\"text-h1\">Change Email</h1>\n\t\t\t<p>You will receive an email at the new email address to confirm.</p>\n\t\t\t<p>\n\t\t\t\tAn email notice will also be sent to your old address {data.user.email}.\n\t\t\t</p>\n\t\t\t<div className=\"mx-auto mt-5 max-w-sm\">\n\t\t\t\t<Form method=\"POST\" {...getFormProps(form)}>\n\t\t\t\t\t<Field\n\t\t\t\t\t\tlabelProps={{ children: 'New Email' }}\n\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\t...getInputProps(fields.email, { type: 'email' }),\n\t\t\t\t\t\t\tautoComplete: 'email',\n\t\t\t\t\t\t}}\n\t\t\t\t\t\terrors={fields.email.errors}\n\t\t\t\t\t/>\n\t\t\t\t\t<ErrorList id={form.errorId} errors={form.errors} />\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<StatusButton\n\t\t\t\t\t\t\tstatus={isPending ? 'pending' : form.status ?? 'idle'}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tSend Confirmation\n\t\t\t\t\t\t</StatusButton>\n\t\t\t\t\t</div>\n\t\t\t\t</Form>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n"],"names":["handle","breadcrumb","jsx","Icon","name","children","getSitemapEntries","ChangeEmailSchema","z","object","email","EmailSchema","ChangeEmailIndex","data","useLoaderData","actionData","useActionData","form","fields","useForm","id","constraint","getZodConstraint","lastResult","result","onValidate","formData","parseWithZod","schema","isPending","useIsPending","className","user","jsxs","Form","method","getFormProps","Field","labelProps","inputProps","getInputProps","type","autoComplete","errors","ErrorList","errorId","StatusButton","status"],"mappings":"wqBA2BO,MAAMA,EAAuC,CACnDC,WAAYC,EAAA,IAACC,EAAK,CAAAC,KAAK,kBAAkBC,SAAY,cAAA,CAAA,EACrDC,kBAAmBA,IAAM,IAC1B,EAIMC,EAAoBC,EAAEC,OAAO,CAClCC,MAAOC,CACR,CAAC,EAsED,SAAwBC,GAAmB,CAC1C,MAAMC,EAAOC,IACPC,EAAaC,IAEb,CAACC,EAAMC,CAAM,EAAIC,EAAQ,CAC9BC,GAAI,oBACJC,WAAYC,EAAiBf,CAAiB,EAC9CgB,WAAYR,GAAAA,YAAAA,EAAYS,OACxBC,WAAW,CAAEC,SAAAA,CAAS,EAAG,CACxB,OAAOC,EAAaD,EAAU,CAAEE,OAAQrB,CAAkB,CAAC,CAC5D,CACD,CAAC,EAEKsB,EAAYC,IAClB,cACE,MACA,CAAAzB,SAAA,CAACH,EAAA,IAAA,KAAA,CAAG6B,UAAU,UAAU1B,SAAY,cAAA,CAAA,EACpCH,EAAA,IAAC,KAAEG,SAA8D,gEAAA,CAAA,SAChE,IAAE,CAAAA,SAAA,CAAA,yDACqDQ,EAAKmB,KAAKtB,MAAM,GAAA,CACxE,CAAA,EACAR,EAAA,IAAC,MAAI,CAAA6B,UAAU,wBACd1B,SAAA4B,EAAA,KAACC,EAAK,CAAAC,OAAO,OAAQ,GAAGC,EAAanB,CAAI,EACxCZ,SAAA,CAAAH,EAAA,IAACmC,EAAA,CACAC,WAAY,CAAEjC,SAAU,WAAY,EACpCkC,WAAY,CACX,GAAGC,EAActB,EAAOR,MAAO,CAAE+B,KAAM,OAAQ,CAAC,EAChDC,aAAc,OACf,EACAC,OAAQzB,EAAOR,MAAMiC,MAAA,CACtB,QACCC,EAAU,CAAAxB,GAAIH,EAAK4B,QAASF,OAAQ1B,EAAK0B,MAAQ,CAAA,QACjD,MACA,CAAAtC,SAAAH,EAAA,IAAC4C,EAAA,CACAC,OAAQlB,EAAY,UAAYZ,EAAK8B,QAAU,OAC/C1C,SAAA,oBAED,CACD,CAAA,CAAA,EACD,CACD,CAAA,CAAA,CACD,CAAA,CAEF"}