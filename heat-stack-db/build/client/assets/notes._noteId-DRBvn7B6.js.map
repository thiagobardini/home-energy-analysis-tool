{"version":3,"file":"notes._noteId-DRBvn7B6.js","sources":["../../../app/routes/users+/$username_+/notes.$noteId.tsx"],"sourcesContent":["import { getFormProps, useForm } from '@conform-to/react'\nimport { parseWithZod } from '@conform-to/zod'\nimport { invariantResponse } from '@epic-web/invariant'\nimport {\n\tjson,\n\ttype LoaderFunctionArgs,\n\ttype ActionFunctionArgs,\n} from '@remix-run/node'\nimport {\n\tForm,\n\tLink,\n\tuseActionData,\n\tuseLoaderData,\n\ttype MetaFunction,\n} from '@remix-run/react'\nimport { formatDistanceToNow } from 'date-fns'\nimport { z } from 'zod'\nimport { GeneralErrorBoundary } from '#app/components/error-boundary.tsx'\nimport { floatingToolbarClassName } from '#app/components/floating-toolbar.tsx'\nimport { ErrorList } from '#app/components/forms.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { prisma } from '#app/utils/db.server.ts'\nimport { getNoteImgSrc, useIsPending } from '#app/utils/misc.tsx'\nimport { requireUserWithPermission } from '#app/utils/permissions.server.ts'\nimport { redirectWithToast } from '#app/utils/toast.server.ts'\nimport { userHasPermission, useOptionalUser } from '#app/utils/user.ts'\nimport { type loader as notesLoader } from './notes.tsx'\n\nexport async function loader({ params }: LoaderFunctionArgs) {\n\tconst note = await prisma.note.findUnique({\n\t\twhere: { id: params.noteId },\n\t\tselect: {\n\t\t\tid: true,\n\t\t\ttitle: true,\n\t\t\tcontent: true,\n\t\t\townerId: true,\n\t\t\tupdatedAt: true,\n\t\t\timages: {\n\t\t\t\tselect: {\n\t\t\t\t\tid: true,\n\t\t\t\t\taltText: true,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t})\n\n\tinvariantResponse(note, 'Not found', { status: 404 })\n\n\tconst date = new Date(note.updatedAt)\n\tconst timeAgo = formatDistanceToNow(date)\n\n\treturn json({\n\t\tnote,\n\t\ttimeAgo,\n\t})\n}\n\nconst DeleteFormSchema = z.object({\n\tintent: z.literal('delete-note'),\n\tnoteId: z.string(),\n})\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst formData = await request.formData()\n\tconst submission = parseWithZod(formData, {\n\t\tschema: DeleteFormSchema,\n\t})\n\tif (submission.status !== 'success') {\n\t\treturn json(\n\t\t\t{ result: submission.reply() },\n\t\t\t{ status: submission.status === 'error' ? 400 : 200 },\n\t\t)\n\t}\n\n\tconst { noteId } = submission.value\n\n\tconst note = await prisma.note.findFirst({\n\t\tselect: { id: true, ownerId: true, owner: { select: { username: true } } },\n\t\twhere: { id: noteId },\n\t})\n\tinvariantResponse(note, 'Not found', { status: 404 })\n\n\tconst isOwner = note.ownerId === userId\n\tawait requireUserWithPermission(\n\t\trequest,\n\t\tisOwner ? `delete:note:own` : `delete:note:any`,\n\t)\n\n\tawait prisma.note.delete({ where: { id: note.id } })\n\n\treturn redirectWithToast(`/users/${note.owner.username}/notes`, {\n\t\ttype: 'success',\n\t\ttitle: 'Success',\n\t\tdescription: 'Your note has been deleted.',\n\t})\n}\n\nexport default function NoteRoute() {\n\tconst data = useLoaderData<typeof loader>()\n\tconst user = useOptionalUser()\n\tconst isOwner = user?.id === data.note.ownerId\n\tconst canDelete = userHasPermission(\n\t\tuser,\n\t\tisOwner ? `delete:note:own` : `delete:note:any`,\n\t)\n\tconst displayBar = canDelete || isOwner\n\n\treturn (\n\t\t<div className=\"absolute inset-0 flex flex-col px-10\">\n\t\t\t<h2 className=\"mb-2 pt-12 text-h2 lg:mb-6\">{data.note.title}</h2>\n\t\t\t<div className={`${displayBar ? 'pb-24' : 'pb-12'} overflow-y-auto`}>\n\t\t\t\t<ul className=\"flex flex-wrap gap-5 py-5\">\n\t\t\t\t\t{data.note.images.map(image => (\n\t\t\t\t\t\t<li key={image.id}>\n\t\t\t\t\t\t\t<a href={getNoteImgSrc(image.id)}>\n\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\tsrc={getNoteImgSrc(image.id)}\n\t\t\t\t\t\t\t\t\talt={image.altText ?? ''}\n\t\t\t\t\t\t\t\t\tclassName=\"h-32 w-32 rounded-lg object-cover\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t))}\n\t\t\t\t</ul>\n\t\t\t\t<p className=\"whitespace-break-spaces text-sm md:text-lg\">\n\t\t\t\t\t{data.note.content}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t\t{displayBar ? (\n\t\t\t\t<div className={floatingToolbarClassName}>\n\t\t\t\t\t<span className=\"text-sm text-foreground/90 max-[524px]:hidden\">\n\t\t\t\t\t\t<Icon name=\"clock\" className=\"scale-125\">\n\t\t\t\t\t\t\t{data.timeAgo} ago\n\t\t\t\t\t\t</Icon>\n\t\t\t\t\t</span>\n\t\t\t\t\t<div className=\"grid flex-1 grid-cols-2 justify-end gap-2 min-[525px]:flex md:gap-4\">\n\t\t\t\t\t\t{canDelete ? <DeleteNote id={data.note.id} /> : null}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tasChild\n\t\t\t\t\t\t\tclassName=\"min-[525px]:max-md:aspect-square min-[525px]:max-md:px-0\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Link to=\"edit\">\n\t\t\t\t\t\t\t\t<Icon name=\"pencil-1\" className=\"scale-125 max-md:scale-150\">\n\t\t\t\t\t\t\t\t\t<span className=\"max-md:hidden\">Edit</span>\n\t\t\t\t\t\t\t\t</Icon>\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t) : null}\n\t\t</div>\n\t)\n}\n\nexport function DeleteNote({ id }: { id: string }) {\n\tconst actionData = useActionData<typeof action>()\n\tconst isPending = useIsPending()\n\tconst [form] = useForm({\n\t\tid: 'delete-note',\n\t\tlastResult: actionData?.result,\n\t})\n\n\treturn (\n\t\t<Form method=\"POST\" {...getFormProps(form)}>\n\t\t\t<input type=\"hidden\" name=\"noteId\" value={id} />\n\t\t\t<StatusButton\n\t\t\t\ttype=\"submit\"\n\t\t\t\tname=\"intent\"\n\t\t\t\tvalue=\"delete-note\"\n\t\t\t\tvariant=\"destructive\"\n\t\t\t\tstatus={isPending ? 'pending' : form.status ?? 'idle'}\n\t\t\t\tdisabled={isPending}\n\t\t\t\tclassName=\"w-full max-md:aspect-square max-md:px-0\"\n\t\t\t>\n\t\t\t\t<Icon name=\"trash\" className=\"scale-125 max-md:scale-150\">\n\t\t\t\t\t<span className=\"max-md:hidden\">Delete</span>\n\t\t\t\t</Icon>\n\t\t\t</StatusButton>\n\t\t\t<ErrorList errors={form.errors} id={form.errorId} />\n\t\t</Form>\n\t)\n}\n\nexport const meta: MetaFunction<\n\ttypeof loader,\n\t{ 'routes/users+/$username_+/notes': typeof notesLoader }\n> = ({ data, params, matches }) => {\n\tconst notesMatch = matches.find(\n\t\tm => m.id === 'routes/users+/$username_+/notes',\n\t)\n\tconst displayName = notesMatch?.data?.owner.name ?? params.username\n\tconst noteTitle = data?.note.title ?? 'Note'\n\tconst noteContentsSummary =\n\t\tdata && data.note.content.length > 100\n\t\t\t? data?.note.content.slice(0, 97) + '...'\n\t\t\t: 'No content'\n\treturn [\n\t\t{ title: `${noteTitle} | ${displayName}'s Notes | Epic Notes` },\n\t\t{\n\t\t\tname: 'description',\n\t\t\tcontent: noteContentsSummary,\n\t\t},\n\t]\n}\n\nexport function ErrorBoundary() {\n\treturn (\n\t\t<GeneralErrorBoundary\n\t\t\tstatusHandlers={{\n\t\t\t\t403: () => <p>You are not allowed to do that</p>,\n\t\t\t\t404: ({ params }) => (\n\t\t\t\t\t<p>No note with the id \"{params.noteId}\" exists</p>\n\t\t\t\t),\n\t\t\t}}\n\t\t/>\n\t)\n}\n"],"names":["NoteRoute","data","useLoaderData","user","useOptionalUser","isOwner","id","note","ownerId","canDelete","userHasPermission","displayBar","jsxs","className","children","jsx","title","images","map","image","href","getNoteImgSrc","src","alt","altText","content","floatingToolbarClassName","Icon","name","timeAgo","DeleteNote","Button","asChild","Link","to","actionData","useActionData","isPending","useIsPending","form","useForm","lastResult","result","Form","method","getFormProps","type","value","StatusButton","variant","status","disabled","ErrorList","errors","errorId","meta","params","matches","notesMatch","find","m","displayName","owner","username","noteTitle","noteContentsSummary","length","slice","ErrorBoundary","GeneralErrorBoundary","statusHandlers","noteId"],"mappings":"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"}